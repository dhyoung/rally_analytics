<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Time In State Insight Chart</title>
        
        <!-- HighCharts -->
        <script type="text/javascript" src="https://people.rallydev.com/js/jquery.min.js"></script>
        <script type="text/javascript" src="https://people.rallydev.com/js/highcharts.js"></script>
        <script type="text/javascript" src="https://people.rallydev.com/js/exporting.js"></script>
        <!-- a theme file
            <script type="text/javascript" src="../js/themes/gray.js"></script>
        -->
        
        <!-- Lumenize -->
        <script type="text/javascript" src="http://lmaccherone.github.com/Lumenize/deploy/lumenize-min.js"></script>
        
        <!-- rally_analytics -->
        
<script type="text/javascript">
((function(){var a,b,c,d,e,f,g,h,i,j=function(a,b){return function(){return a.apply(b,arguments)}},k=Object.prototype.hasOwnProperty,l=function(a,b){function d(){this.constructor=a}for(var c in b)k.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},m=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(k.call(this,b)&&this[b]===a)return b;return-1};i=this,h=function(){var a,b,c,d,e;a={},e="Boolean Number String Function Array Date RegExp Undefined Null".split(" ");for(c=0,d=e.length;c<d;c++)b=e[c],a["[object "+b+"]"]=b.toLowerCase();return function(b){var c;return c=Object.prototype.toString.call(b),a[c]||"object"}}(),a=function(){function a(a,b){var c,d,e,f,g,h,i;this._XHRClass=b,this._gotResponse=j(this._gotResponse,this),this.debug=!1;if(this._XHRClass==null)throw new Error("Must provide an XHRClass as the second parameter for this AnalyticsQuery constructor.");this._xhr=null,this._find=null,this._fields=null,this._sort={_ValidFrom:1},this._startIndex=0,this._pageSize=1e5,this._callback=null,this.headers={},this.headers["X-RallyIntegrationLibrary"]="rally_analytics-0.1.0",typeof navigator!="undefined"&&navigator!==null?(f=navigator.appName+" "+navigator.appVersion,g=navigator.userAgent,e=navigator.platform):typeof process!="undefined"&&process!==null&&(f="Node.js (or some other non-browser) "+process.version,g="Rally analytics toolkit on Node.js (or some other non-browser)",e=process.platform),this.headers["X-RallyIntegrationPlatform"]=f,this.headers["X-RallyIntegrationOS"]=e,i=a.additionalHeaders;for(d in i)h=i[d],this.headers[d]=h;c=function(b,c){if(a[c]!=null)return b[c]=a[c];throw new Error("Must include config["+c+"] header when instantiating this rally_analytics.AnalyticsQuery object")},c(this.headers,"X-RallyIntegrationName"),c(this.headers,"X-RallyIntegrationVendor"),c(this.headers,"X-RallyIntegrationVersion");if(a.workspaceOID==null)throw new Error("Must provide a config.workspaceOID");this.workspaceOID=a.workspaceOID,this.username=a.username,this.password=a.password,this.protocol="https",this.server="rally1.rallydev.com",this.service="analytics",this.version="1.27",this.endpoint="artifact/snapshot/query.js",this._firstPage=!0,this.ETLDate=null,this.lastResponseText="",this.lastResponse={},this.lastMeta={},this.allResults=[],this.allMeta=[]}return a.prototype.resetFind=function(){return this._find=null},a.prototype.find=function(a){return this._find=a,this},a.prototype.sort=function(a){return this._sort=a,this},a.prototype.fields=function(a){return this._fields=a,this},a.prototype.start=function(a){return this._startIndex=a,this},a.prototype.startIndex=function(a){return this._startIndex=a,this},a.prototype.pagesize=function(a){return this._pageSize=a,this},a.prototype.pageSize=function(a){return this._pageSize=a,this},a.prototype.auth=function(a,b){return this.username=a,this.password=b,this},a.prototype.getBaseURL=function(){return this.protocol+"://"+[this.server,this.service,this.version,this.workspaceOID,this.endpoint].join("/")},a.prototype.getQueryString=function(){var a,b;a=JSON.stringify(this._find);if(this._find!=null&&a.length>2)return b=[],b.push("find="+a),this._sort!=null&&b.push("sort="+JSON.stringify(this._sort)),this._fields!=null&&b.push("fields="+JSON.stringify(this._fields)),b.push("start="+this._startIndex),b.push("pagesize="+this._pageSize),b.join("&");throw new Error("find clause not set")},a.prototype.getURL=function(){return this.getBaseURL()+"?"+this.getQueryString()},a.prototype.getAll=function(a){var b,c,d;this._callback=a;if(this._find==null)throw new Error("Must set find clause before calling getAll");this._xhr=new this._XHRClass,this._xhr.onreadystatechange=this._gotResponse,this._xhr.open("GET",this.getURL(),!0,this.username,this.password),d=this.headers;for(b in d)c=d[b],this._xhr.setRequestHeader(b,c);return this._xhr.send(),this},a.prototype._gotResponse=function(){var a,b,c,d,e,f,g,h,i,j,k=this;if(this._xhr.readyState===4){j=function(){return k._firstPage=!0,k._startIndex=0,k._callback.call(k)},this.lastResponseText=this._xhr.responseText,this.debug&&console.log("\nlastResponse\n"+this.lastResponseText),this.lastResponse=JSON.parse(this.lastResponseText),this._firstPage&&(this._firstPage=!1,this.allResults=[],this.allMeta=[],this.ETLDate=this.lastResponse.ETLDate,this._pageSize=this.lastResponse.PageSize,b={$and:[this._find,{_ValidFrom:{$lte:this.ETLDate}}]},this._find=b),g=this.lastResponse.Results;for(e=0,f=g.length;e<f;e++)c=g[e],this.allResults.push(c);this.lastMeta={},h=this.lastResponse;for(a in h)d=h[a],a!=="Results"&&(this.lastMeta[a]=d);this.allMeta.push(this.lastMeta);if(this.lastResponse.Results.length+this.lastResponse.StartIndex>=this.lastResponse.TotalResultCount)return j();this._startIndex+=this._pageSize,this._xhr=new this._XHRClass,this._xhr.onreadystatechange=this._gotResponse,this._xhr.open("GET",this.getURL(),!0,this.username,this.password),i=this.headers;for(a in i)d=i[a],this._xhr.setRequestHeader(a,d);return this._xhr.send()}},a}(),e=function(){function b(a,c){this._XHRClass=c,b.__super__.constructor.call(this,a,this._XHRClass),this._scope={},this._type=null,this._additionalCriteria=[]}return l(b,a),b.prototype.generateFind=function(){var a,b,c,d,e,f;b=[];if(JSON.stringify(this._scope).length>2){b.push(this._scope),this._type!=null&&b.push(this._type),e=this._additionalCriteria;for(c=0,d=e.length;c<d;c++)a=e[c],b.push(a);return 0<(f=b.length)&&f<2?b[0]:{$and:b}}throw new Error("Must set scope first.")},b.prototype.find=function(){if(arguments.length>0)throw new Error("Do not call find() directly to set query. Use scope(), type(), and additionalCriteria()");return b.__super__.find.call(this,this.generateFind())},b.prototype.resetScope=function(){return this._scope={}},b.prototype.scope=function(a,b){var c,d,e,f=this;c=function(a,b){var c;a==="ItemHierarchy"&&(a="_ItemHierarchy"),a==="Tag"&&(a="Tags"),a==="ProjectHierarchy"&&(a="_ProjectHierarchy"),c=["Project","_ProjectHierarchy","Iteration","Release","Tags","_ItemHierarchy"];if(m.call(c,a)<0)throw new Error("Key for scope() call must be one of "+c);return h(b)==="array"?f._scope[a]={$in:b}:f._scope[a]=b};if(h(a)==="object")for(d in a)e=a[d],c(d,e);else{if(arguments.length!==2)throw new Error("Must provide an Object in first parameter or two parameters (key, value).");c(a,b)}return this},b.prototype.resetType=function(){return this._type=null},b.prototype.type=function(a){return this._type={_Type:a},this},b.prototype.resetAdditionalCriteria=function(){return this._additionalCriteria=[]},b.prototype.additionalCriteria=function(a){return this._additionalCriteria.push(a),this},b.prototype.leafOnly=function(){return this.additionalCriteria({$or:[{_Type:"HierarchicalRequirement",Children:null},{_Type:"PortfolioItem",Children:null,UserStories:null}]}),this},b.prototype.getAll=function(a){return this.find(),b.__super__.getAll.call(this,a)},b}(),b=function(){function a(b,c,d){this._XHRClass=c,a.__super__.constructor.call(this,b,this._XHRClass);if(d==null)throw new Error("Must provide a zuluDateString when instantiating an AtAnalyticsQuery.");this._additionalCriteria.push({_At:d})}return l(a,e),a}(),c=function(){function a(b,c,d){throw this._XHRClass=c,a.__super__.constructor.call(this,b,this._XHRClass),new Error("AtArrayAnalyticsQuery is not yet implemented")}return l(a,e),a}(),d=function(){function a(b,c,d,e){var f;this._XHRClass=c,a.__super__.constructor.call(this,b,this._XHRClass);if(d==null||e==null)throw new Error("Must provide two zuluDateStrings when instantiating a BetweenAnalyticsQuery.");f={$or:[{_ValidFrom:{$lte:d},_ValidTo:{$gt:d}},{_ValidFrom:{$gte:d,$lt:e}}]},this._additionalCriteria.push(f),this.sort({_ValidFrom:1})}return l(a,e),a}(),f=function(){function a(b,c,d){throw this._XHRClass=c,a.__super__.constructor.call(this,b,this._XHRClass),new Error("Not yet implemented")}return l(a,e),a}(),g=function(){function a(b,c,d){throw this._XHRClass=c,a.__super__.constructor.call(this,b,this._XHRClass),new Error("Not yet implemented")}return l(a,e),a}(),i.AnalyticsQuery=a,i.GuidedAnalyticsQuery=e,i.AtAnalyticsQuery=b,i.AtArrayAnalyticsQuery=c,i.BetweenAnalyticsQuery=d,i.TimeInStateAnalyticsQuery=f,i.TransitionsAnalyticsQuery=g})).call(this)
</script> 
        
        <!-- my calculator for this chart (optional) -->
        
        <script type="text/javascript">
        
            if (__WORKSPACE_OID__) {
            } else {
              var __WORKSPACE_OID__ = 41529001;
              var __PROJECT_SCOPING_UP__ = false;
              var __PROJECT_SCOPING_DOWN__ = true;
              var __PROJECT_OID__ = 279050021;
            };
        
            var lumenize = require('/lumenize');
            var ChartTime = lumenize.ChartTime;
            ChartTime.setTZPath('All');  // Inside the browser, the tz files are embedded.
            var ChartTimeRange = lumenize.ChartTimeRange;
            var histogram = lumenize.histogram;
            
            var workspaceConfiguration = {  // Need to grab from Rally for this user
              DateFormat: 'MM/dd/yyyy',
              DateTimeFormat: 'MM/dd/yyyy hh:mm:ss a',
              IterationEstimateUnitName: 'Points',
              ReleaseEstimateUnitName: 'Points',
              TaskUnitName: 'Hours',
              TimeTrackerEnabled: true,
              TimeZone: 'America/Denver',
              WorkDays: 'Monday,Tuesday,Wednesday,Thursday,Friday' // They work on Sundays
            };
            
            var chartConfig = {
              pastEndJSDate: new Date(),  // should add one day
              daysBack: 90,
              // startJSDate: ????  // Not used but could specify start and pastEnd instead of now - n days
            };
            
            var rangeSpec, i1, r1;
            
            $(document).ready(function() {

              var granularity = 'hour';
            
              rangeSpec = {
                granularity: granularity,
                start: '2011-01-01',
                pastEnd: '2011-04-01',
                startWorkTime: {
                  hour: 9,
                  minute: 0
                },
                pastEndWorkTime: {
                  hour: 17,
                  minute: 0
                }
              };
            
              r1 = new ChartTimeRange(rangeSpec);
            
              i1 = r1.getIterator('ChartTime');
            
              config = {
                'X-RallyIntegrationName': 'Time In State Insight (prototype)',
                'X-RallyIntegrationVendor': 'Rally The A-Team',
                'X-RallyIntegrationVersion': '0.1.0',
                // username: username,  // will prompt in browser if missing
                // password: password,
                workspaceOID: __WORKSPACE_OID__
              };

              query = new GuidedAnalyticsQuery(config, XMLHttpRequest);
            
              // The settings below are the defaults and unnessary unless you want to alter them
              // query.debug = false;
              // query.protocol = 'https';  
              // query.server = 'rally1.rallydev.com';
              // query.service = 'analytics';
              // query.version = '1.27';
              
              if (__PROJECT_SCOPING_UP__) {
                alert('Scoping up not yet supported');
              } else {
                if (__PROJECT_SCOPING_DOWN__) {
                  query.scope('_ProjectHierarchy', __PROJECT_OID__)
                } else {
                  query.scope('Project', __PROJECT_OID__)
                };
              };
            
              query
                .type('HierarchicalRequirement')
                .leafOnly();
            
              query.fields(['ObjectID', '_ValidFrom', 'KanbanState', 'PlanEstimate']);
            
              query.find() // Only called here to set _find for debugging
              console.log('Query\n' + JSON.stringify(query._find, undefined, 2));
              console.log('Requesting data...');
              
              // query.getAll(callback);
              
              callback([]);
            });
            
            callback = function(snapshots) {
                
                var uniqueIDField = 'ObjectID';
                
                // start = new ChartTime('2011-01-01', 'day').getJSDateString(workspaceConfiguration.TimeZone);
                // pastEnd = new ChartTime('2011-04-01', 'day').getJSDateString(workspaceConfiguration.TimeZone);
                // snapshots = getAllSnapshots({_ValidFrom: {$gte: start, $lt: pastEnd}});
                // isc1 = i1.getChartTimeInStateCalculator(workspaceConfiguration.TimeZone);
                // timeInState = isc1.timeInState(snapshots, '_ValidFrom', '_ValidTo', uniqueIDField);
       
                // ---
                // Replace with call to ChartTimeInState above
                var timeInState = [];
                var row;
                var hourCT;
                
                baseChance = Math.random() * 0.5
                while (i1.hasNext()) {
                  hourCT = i1.next();
                  if (Math.random() < baseChance) {
                    row = {
                      ObjectID: i1.count,
                      ticks: Math.pow(4, (Math.random() + 0.7) * 2.6) + 4 * 8,
                      finalEventAt: hourCT.getJSDate(workspaceConfiguration.TimeZone)
                    };
                    timeInState.push(row);
                    if (Math.random() < baseChance) {  // different value but same hourCT
                      row = {
                        ObjectID: i1.count,
                        ticks: Math.pow(4, (Math.random() + 0.7) * 2.6) + 4 * 8,
                        finalEventAt: hourCT.getJSDate(workspaceConfiguration.TimeZone)
                      };
                      timeInState.push(row);
                    }                   
                  }
                  if (Math.random() < baseChance / 20) {
                    row = {
                      ObjectID: i1.count,
                      ticks: Math.pow(4, (Math.random() + 0.9) * 2.6),
                      finalEventAt: hourCT.getJSDate(workspaceConfiguration.TimeZone)
                    };
                    timeInState.push(row);
                  }
                  if (Math.random() < baseChance / 20) {
                    row = {
                      ObjectID: i1.count,
                      ticks: Math.random() * 40,
                      finalEventAt: hourCT.getJSDate(workspaceConfiguration.TimeZone)
                    };
                    timeInState.push(row);
                  }
                }
                // ----

                var workMinutes;
                if (r1.startWorkMinutes < r1.pastEndWorkMinutes) {
                  workMinutes = r1.pastEndWorkMinutes - r1.startWorkMinutes;
                } else {
                  workMinutes = 24 * 60 - r1.startWorkMinutes;
                  workMinutes += r1.pastEndWorkMinutes;
                }
                var workHours = workMinutes / 60;
                            
                var _i, _len;
                var data = [];
                for (_i = 0, _len = timeInState.length; _i < _len; _i++) {
                  row = timeInState[_i];
                  row.days = row.ticks / workHours;
                }
                
                var histogramField = 'days';
              
                var histogramResults = histogram(timeInState, histogramField);
                if (! histogramResults) {
                  return;
                }
                var buckets = histogramResults.buckets;
                var chartMax = histogramResults.chartMax;
                var valueMax = histogramResults.valueMax;
                var bucketSize = histogramResults.bucketSize;
                var clipped = histogramResults.clipped;
                var data = [];
                var tooltipLookup = {};
                for (_i = 0, _len = timeInState.length; _i < _len; _i++) {
                  row = timeInState[_i];
                  milliseconds = row.finalEventAt.getTime();
                  while (tooltipLookup[milliseconds]) {  // Hack so we get different index
                    milliseconds++;
                  };
                  data.push([milliseconds, row.clippedChartValue]);
                  tooltipLookup[milliseconds] = row;
                }
              
                var histogramCategories = [];
                var histogramData = [];
                var b, idx, _len2;
                for (idx = 0, _len2 = buckets.length; idx < _len2; idx++) {
                  b = buckets[idx];
                  histogramCategories.push(b.label);
                  histogramData.push(b.count);
                }
                
                scatter = new Highcharts.Chart({
                    chart: {
                        renderTo: 'scatter-container',
                        defaultSeriesType: 'scatter'
                    },
                    legend: {
                        enabled: false
                    },
                    credits: {
                        enabled: false
                    },
                    title: {
                        text: 'Time In State Insight'
                    },
                    subtitle: {
                        text: ''
                    },
                    xAxis: {
                        startOnTick: false,
                        tickmarkPlacement: 'on',
                        title: {
                            enabled: false
                        },
                        type: 'datetime'
                    },
                    yAxis: [
                        {
                            title: {
                                text: 'Time In State (Work Days)'
                            },
                            opposite: false,
                            endOnTick: false,
                            tickInterval: bucketSize,
                            labels: {
                                formatter: function() {
                                    // console.log(JSON.stringify(this, undefined, 2));
                                    if (this.value != 0) {
                                        if (this.value == chartMax) {
                                          if (clipped) {
                                            return '' + valueMax + '*';
                                          } else {
                                            return chartMax;
                                          }
                                        } else {
                                          return this.value / 1;
                                        }
                                    }
                                }
                            },
                            min: 0,
                            max: chartMax
                        },
                        {
                            title: {
                                text: null
                            },
                            opposite: true,
                            // endOnTick: true,
                            tickInterval: 1,
                            labels: {
                                formatter: function() {
                                    if (this.value != 0) {
                                      return Highcharts.numberFormat(buckets[this.value - 1].percentile * 100, 1) + "%";
                                    } else {
                                      return "0.0%"
                                    }
                                }
                            },
                            min: 0,
                            max: buckets.length                        
                        }

                    ],                      
                    tooltip: {
                        formatter: function() {
                            var lookupRow = tooltipLookup[this.x];
                            return uniqueIDField + ': ' + lookupRow[uniqueIDField] + '<br />' + // !TODO: Upgrade to link to revisions page in Rally
                              this.series.name + ': <b>' + Highcharts.numberFormat(lookupRow[histogramField], 1) + '</b> work days';
                        }
                    },
              		  series: [
                  		  {
                      			name: 'Time in state',
                      			data: data,
                      			yAxis: 0
                        },
                    		{
                      		  name: 'Percentile',
                      		  data: [],
                      		  yAxis: 1
                    		}
                    ]
                }, function(chart) {
              	     if (clipped) {
                       chart.renderer.text('* non-linear', 57, 55).add();
                     };
                });
 
                
                
                histogram = new Highcharts.Chart({
              		chart: {
              			renderTo: 'histogram-container',
              			type: 'bar'
              		},
                  legend: {
                    enabled: false
                  },
                  credits: {
                      enabled: false
                  },
              		title: {
              			text: 'Histogram'
              		},
              		subtitle: {
              			text: ''
              		},
              		xAxis: [{ // mirror axis on right side
              			opposite: false,
              			reversed: false,
              			categories: histogramCategories,
              		}],
              		yAxis: {
              			title: {
              				text: null
              			},
                    labels: {
              				formatter: function(){
              					return Math.abs(this.value);
              				}
              			},
              			min: 0
              		},
              		plotOptions: {
              			series: {
              				stacking: 'normal'
              			}
              		},
              		tooltip: {
              			formatter: function(){
              				return '' + this.point.category +' work days: <b>' + Highcharts.numberFormat(Math.abs(this.point.y), 0) + '</b>';
              			}
              		},
              		series: [{
              			name: 'Time in state',
              			data: histogramData
              		}]
              	}, function(chart) {
              	     if (false) {
                       chart.renderer.text('* non-linear', 200, 65).add();
                     };
                });

            };
                
        </script>
        
    </head>
    <body>
        
        <!-- 3. Add the containers -->
        <table cellpading="0px" cellspacing="0px" width="98%" height="98%">
          <tr>
            <td width="65%"><div id="scatter-container" style="width: 100%; height: 100%; margin: 0 auto"></div></td>
            <td width="35%"><div id="histogram-container" style="width: 100%; height: 100%; margin: 0 auto"></div></td>
          </tr>
        </table>
                
    </body>
</html>


